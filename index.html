<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NutriTrack</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- â•â•â• FIREBASE â•â•â• -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, signOut, onAuthStateChanged }
  from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, query, orderBy, onSnapshot,
         updateDoc, deleteDoc, where, serverTimestamp, limit }
  from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA7R-rCJ1B63j95qPctFf0gYgCiVtOvvOw",
  authDomain: "dietapp-8ad72.firebaseapp.com",
  projectId: "dietapp-8ad72",
  storageBucket: "dietapp-8ad72.firebasestorage.app",
  messagingSenderId: "903928286116",
  appId: "1:903928286116:web:84a2013356a2740fed8f31"
};

const app   = initializeApp(firebaseConfig);
const auth  = getAuth(app);
const db    = getFirestore(app);

window._fb = { auth, db, createUserWithEmailAndPassword, signInWithEmailAndPassword,
               sendPasswordResetEmail, signOut, onAuthStateChanged,
               collection, doc, setDoc, getDoc, getDocs, addDoc, query,
               orderBy, onSnapshot, updateDoc, deleteDoc, where, serverTimestamp, limit };

// Auth state listener â†’ bootstrap app
onAuthStateChanged(auth, async user => {
  if (user) {
    const snap = await getDoc(doc(db, 'users', user.uid));
    if (snap.exists()) {
      window._currentUser = { uid: user.uid, email: user.email, ...snap.data() };
    } else {
      window._currentUser = { uid: user.uid, email: user.email, name: user.email.split('@')[0], role: 'user' };
    }
    showApp();
  } else {
    window._currentUser = null;
    showAuth();
  }
});
</script>

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BRAND TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --green:    #4a7a35;
  --green-l:  #5c9642;
  --green-bg: #eef4eb;
  --orange:   #e07020;
  --orange-l: #f08030;
  --orange-bg:#fdf0e6;
  --cream:    #f3ede2;
  --cream2:   #ece5d8;
  --white:    #ffffff;
  --card:     #ffffff;
  --border:   #ddd6c8;
  --text:     #2a2420;
  --text2:    #5a5048;
  --muted:    #9a8f85;
  --danger:   #dc4a3a;
  --danger-bg:#fdecea;
  --shadow:   0 2px 12px rgba(0,0,0,0.07);
  --shadow-md:0 4px 20px rgba(0,0,0,0.10);
  --radius:   16px;
  --radius-sm:10px;

  --font-brand: 'Nunito', sans-serif;
  --font-body:  'DM Sans', sans-serif;
  --font-mono:  'DM Mono', monospace;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--cream);
  color: var(--text);
  font-family: var(--font-body);
  min-height: 100vh;
  overflow-x: hidden;
}

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#auth-screen {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
  background: var(--cream);
  background-image: radial-gradient(ellipse at 20% 80%, rgba(74,122,53,0.08) 0%, transparent 50%),
                    radial-gradient(ellipse at 80% 20%, rgba(224,112,32,0.08) 0%, transparent 50%);
}

.auth-box {
  background: var(--white);
  border-radius: 24px;
  padding: 48px 40px;
  width: 100%;
  max-width: 420px;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border);
}

/* Logo SVG */
.logo-wrap {
  text-align: center;
  margin-bottom: 32px;
}

.logo-svg-nutri { font-family: var(--font-brand); font-weight: 900; font-size: 44px; fill: var(--green); letter-spacing: -1px; }
.logo-svg-track { font-family: var(--font-brand); font-weight: 900; font-size: 44px; fill: var(--orange); letter-spacing: -1px; }

.auth-tabs {
  display: flex;
  background: var(--cream);
  border-radius: var(--radius-sm);
  padding: 4px;
  gap: 4px;
  margin-bottom: 28px;
}
.auth-tab {
  flex: 1;
  padding: 10px;
  border: none;
  background: transparent;
  border-radius: 8px;
  font-family: var(--font-brand);
  font-weight: 700;
  font-size: 14px;
  color: var(--muted);
  cursor: pointer;
  transition: all 0.2s;
}
.auth-tab.active { background: var(--white); color: var(--green); box-shadow: var(--shadow); }

.auth-form { display: flex; flex-direction: column; gap: 14px; }
.auth-form.hidden { display: none; }

.form-group { display: flex; flex-direction: column; gap: 6px; }
.form-label {
  font-size: 12px;
  font-weight: 600;
  color: var(--text2);
  letter-spacing: 0.5px;
  text-transform: uppercase;
  font-family: var(--font-brand);
}

input, select, textarea {
  background: var(--cream);
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: var(--font-body);
  font-size: 15px;
  padding: 11px 14px;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
  width: 100%;
}
input:focus, select:focus, textarea:focus {
  border-color: var(--green);
  box-shadow: 0 0 0 3px rgba(74,122,53,0.12);
  background: var(--white);
}
input::placeholder { color: var(--muted); }
select option { background: var(--white); }
textarea { resize: vertical; min-height: 80px; }

.btn {
  border: none;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-family: var(--font-brand);
  font-weight: 700;
  font-size: 15px;
  padding: 12px 22px;
  transition: all 0.2s;
  white-space: nowrap;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 7px;
}

.btn-green  { background: var(--green); color: white; }
.btn-green:hover { background: var(--green-l); transform: translateY(-1px); box-shadow: 0 4px 14px rgba(74,122,53,0.3); }
.btn-orange { background: var(--orange); color: white; }
.btn-orange:hover { background: var(--orange-l); transform: translateY(-1px); box-shadow: 0 4px 14px rgba(224,112,32,0.3); }
.btn-ghost  { background: transparent; border: 1.5px solid var(--border); color: var(--text2); }
.btn-ghost:hover { background: var(--cream); border-color: var(--green); color: var(--green); }
.btn-danger { background: var(--danger-bg); color: var(--danger); border: 1px solid rgba(220,74,58,0.25); }
.btn-danger:hover { background: #fad5d0; }
.btn-sm { padding: 7px 14px; font-size: 13px; border-radius: 8px; }
.btn-xs { padding: 5px 10px; font-size: 12px; border-radius: 7px; }
.btn-icon { width: 34px; height: 34px; padding: 0; border-radius: 8px; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

.forgot-link {
  text-align: center;
  font-size: 13px;
  color: var(--muted);
  cursor: pointer;
  text-decoration: underline;
  margin-top: -4px;
}
.forgot-link:hover { color: var(--green); }

.auth-error {
  padding: 10px 14px;
  background: var(--danger-bg);
  border: 1px solid rgba(220,74,58,0.25);
  border-radius: 8px;
  font-size: 13px;
  color: var(--danger);
  display: none;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP SHELL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app-screen { display: none; }

.sidebar {
  position: fixed;
  left: 0; top: 0;
  width: 76px;
  height: 100vh;
  background: var(--white);
  border-right: 1.5px solid var(--border);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px 0;
  gap: 4px;
  z-index: 100;
  box-shadow: 2px 0 12px rgba(0,0,0,0.04);
}

.sidebar-logo {
  margin-bottom: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  line-height: 1;
}
.sidebar-logo span:first-child { font-family: var(--font-brand); font-weight: 900; font-size: 15px; color: var(--green); letter-spacing: -0.5px; }
.sidebar-logo span:last-child  { font-family: var(--font-brand); font-weight: 900; font-size: 15px; color: var(--orange); letter-spacing: -0.5px; }

.nav-btn {
  width: 52px; height: 52px;
  border-radius: 14px;
  border: none;
  background: transparent;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 3px;
  transition: all 0.2s;
}
.nav-btn svg { width: 20px; height: 20px; stroke: var(--muted); fill: none; stroke-width: 2; transition: stroke 0.2s; }
.nav-btn span { font-family: var(--font-brand); font-weight: 700; font-size: 8px; color: var(--muted); letter-spacing: 0.5px; transition: color 0.2s; }
.nav-btn:hover { background: var(--cream); }
.nav-btn:hover svg { stroke: var(--green); }
.nav-btn:hover span { color: var(--green); }
.nav-btn.active { background: var(--green-bg); }
.nav-btn.active svg { stroke: var(--green); }
.nav-btn.active span { color: var(--green); }

.sidebar-bottom {
  margin-top: auto;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}
.user-avatar {
  width: 36px; height: 36px;
  border-radius: 50%;
  background: var(--green-bg);
  border: 2px solid var(--green);
  display: flex; align-items: center; justify-content: center;
  font-family: var(--font-brand);
  font-weight: 800;
  font-size: 14px;
  color: var(--green);
  cursor: pointer;
}
.logout-btn {
  width: 36px; height: 36px;
  border-radius: 10px;
  border: 1.5px solid var(--border);
  background: transparent;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s;
}
.logout-btn svg { width: 16px; height: 16px; stroke: var(--muted); fill: none; stroke-width: 2; }
.logout-btn:hover { background: var(--danger-bg); border-color: var(--danger); }
.logout-btn:hover svg { stroke: var(--danger); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN CONTENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main {
  margin-left: 76px;
  min-height: 100vh;
  padding: 32px;
  max-width: 1200px;
}

.page { display: none; }
.page.active { display: block; animation: fadeUp 0.3s ease; }

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(10px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* â”€â”€ PAGE HEADER â”€â”€ */
.page-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 28px;
  flex-wrap: wrap;
  gap: 12px;
}
.page-title-tag {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--muted);
  letter-spacing: 1.5px;
  text-transform: uppercase;
  margin-bottom: 4px;
}
h1 { font-family: var(--font-brand); font-weight: 900; font-size: 30px; color: var(--text); letter-spacing: -0.5px; }
h2 { font-family: var(--font-brand); font-weight: 800; font-size: 20px; color: var(--text); }
h3 { font-family: var(--font-brand); font-weight: 700; font-size: 16px; color: var(--text); }

/* â”€â”€ CARD â”€â”€ */
.card {
  background: var(--card);
  border: 1.5px solid var(--border);
  border-radius: var(--radius);
  padding: 22px;
  box-shadow: var(--shadow);
}
.card-sm { padding: 14px 18px; border-radius: 12px; }

/* â”€â”€ GRID â”€â”€ */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
.grid-4 { display: grid; grid-template-columns: repeat(4,1fr); gap: 14px; }

/* â”€â”€ STAT CHIP â”€â”€ */
.stat-chip {
  background: var(--cream);
  border: 1.5px solid var(--border);
  border-radius: 12px;
  padding: 14px 18px;
  text-align: center;
}
.stat-chip .val { font-family: var(--font-brand); font-weight: 900; font-size: 22px; }
.stat-chip .lbl { font-family: var(--font-mono); font-size: 9px; color: var(--muted); letter-spacing: 1.5px; margin-top: 2px; }

/* â”€â”€ MACRO PILLS â”€â”€ */
.macro-pill { font-family: var(--font-mono); font-size: 10px; padding: 3px 8px; border-radius: 6px; white-space: nowrap; }
.mp-kcal { background: rgba(74,122,53,0.1);  color: var(--green); }
.mp-prot { background: rgba(224,112,32,0.1); color: var(--orange); }
.mp-carb { background: rgba(59,130,246,0.1); color: #3b82f6; }
.mp-fat  { background: rgba(234,179,8,0.1);  color: #ca8a04; }

/* â”€â”€ BANNER â”€â”€ */
.banner {
  padding: 14px 20px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
}
.banner-warn { background: rgba(224,112,32,0.08); border: 1.5px solid rgba(224,112,32,0.25); }
.banner-ok   { background: var(--green-bg); border: 1.5px solid rgba(74,122,53,0.25); }

/* â”€â”€ SECTION HEADER â”€â”€ */
.sec-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}

/* â”€â”€ DIVIDER â”€â”€ */
.divider { height: 1.5px; background: var(--border); margin: 20px 0; }

/* â”€â”€ WEIGHT INPUT â”€â”€ */
.weight-input-row {
  display: flex;
  align-items: center;
  gap: 10px;
}
.weight-input-row input[type="number"] {
  width: 120px;
  font-family: var(--font-brand);
  font-weight: 900;
  font-size: 26px;
  text-align: center;
}

/* â”€â”€ CHART â”€â”€ */
.chart-wrap { position: relative; height: 240px; }

/* â”€â”€ HISTORY ROW â”€â”€ */
.hist-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 11px 18px;
  border-bottom: 1.5px solid var(--border);
  transition: background 0.15s;
}
.hist-row:last-child { border-bottom: none; }
.hist-row:hover { background: var(--cream); }

/* â”€â”€ FOOD AUTOCOMPLETE â”€â”€ */
.ac-wrap { position: relative; }
.ac-list {
  position: absolute;
  top: calc(100% + 4px);
  left: 0; right: 0;
  background: var(--white);
  border: 1.5px solid var(--border);
  border-radius: 12px;
  z-index: 50;
  max-height: 220px;
  overflow-y: auto;
  box-shadow: var(--shadow-md);
  display: none;
}
.ac-list.open { display: block; }
.ac-item {
  padding: 10px 14px;
  cursor: pointer;
  font-size: 13px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.ac-item:hover { background: var(--cream); }
.ac-item:first-child { border-radius: 10px 10px 0 0; }
.ac-item:last-child  { border-radius: 0 0 10px 10px; }

/* â”€â”€ TABS â”€â”€ */
.tabs {
  display: flex; gap: 4px;
  background: var(--cream);
  border: 1.5px solid var(--border);
  border-radius: 12px;
  padding: 4px;
  margin-bottom: 20px;
}
.tab {
  flex: 1; padding: 8px 14px;
  border: none; background: transparent;
  color: var(--muted); cursor: pointer;
  border-radius: 8px;
  font-family: var(--font-brand);
  font-weight: 700;
  font-size: 13px;
  transition: all 0.2s;
}
.tab:hover { color: var(--green); }
.tab.active { background: var(--white); color: var(--green); box-shadow: var(--shadow); }
.tab-panel { display: none; }
.tab-panel.active { display: block; animation: fadeUp 0.2s ease; }

/* â”€â”€ BADGE â”€â”€ */
.badge {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 4px 10px; border-radius: 20px;
  font-family: var(--font-brand); font-weight: 700; font-size: 11px;
}
.badge-green  { background: var(--green-bg);  color: var(--green); }
.badge-orange { background: var(--orange-bg); color: var(--orange); }
.badge-admin  { background: rgba(220,74,58,0.08); color: var(--danger); }

/* â”€â”€ PROGRESS BAR â”€â”€ */
.progress-track { height: 10px; background: var(--cream); border-radius: 100px; overflow: hidden; border: 1.5px solid var(--border); }
.progress-fill  { height: 100%; border-radius: 100px; transition: width 0.6s ease; }

/* â”€â”€ MODAL OVERLAY â”€â”€ */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.35);
  backdrop-filter: blur(3px);
  z-index: 200;
  display: flex; align-items: center; justify-content: center;
  padding: 24px;
  display: none;
}
.modal-overlay.open { display: flex; }
.modal-box {
  background: var(--white);
  border-radius: 20px;
  padding: 32px;
  width: 100%;
  max-width: 480px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.15);
  animation: fadeUp 0.25s ease;
}
.modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }

/* â”€â”€ TOAST â”€â”€ */
#toast {
  position: fixed; bottom: 24px; right: 24px;
  background: var(--text); color: white;
  border-radius: 12px; padding: 13px 20px;
  font-family: var(--font-brand); font-weight: 600; font-size: 14px;
  z-index: 999;
  transform: translateY(60px); opacity: 0;
  transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
  display: flex; align-items: center; gap: 10px;
  max-width: 320px;
}
#toast.show { transform: translateY(0); opacity: 1; }
#toast .t-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

/* â”€â”€ EMPTY â”€â”€ */
.empty { text-align: center; padding: 40px 20px; color: var(--muted); }
.empty-icon { font-size: 38px; margin-bottom: 10px; opacity: 0.5; }
.empty p { font-size: 13px; }

/* â”€â”€ ADMIN TABLE â”€â”€ */
.admin-table { width: 100%; border-collapse: collapse; }
.admin-table th {
  text-align: left; font-family: var(--font-mono); font-size: 10px;
  color: var(--muted); letter-spacing: 1.5px; padding: 8px 14px;
  border-bottom: 1.5px solid var(--border); background: var(--cream);
}
.admin-table td {
  padding: 12px 14px; font-size: 14px;
  border-bottom: 1.5px solid var(--border);
}
.admin-table tr:last-child td { border-bottom: none; }
.admin-table tr:hover td { background: var(--cream); cursor: pointer; }

/* â”€â”€ DIARY ENTRY â”€â”€ */
.diary-entry {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 16px;
  background: var(--cream);
  border: 1.5px solid var(--border);
  border-radius: 12px;
  margin-bottom: 8px;
}
.diary-entry:hover { border-color: var(--green); }
.diary-entry .food-name { flex: 1; font-weight: 600; font-size: 14px; }

/* â”€â”€ LEGENDA TABLE â”€â”€ */
.legenda-table { width: 100%; border-collapse: collapse; }
.legenda-table th {
  background: var(--green);
  color: white;
  font-family: var(--font-brand);
  font-weight: 700;
  font-size: 12px;
  padding: 10px 16px;
  text-align: left;
}
.legenda-table td {
  padding: 10px 16px;
  font-size: 13px;
  border-bottom: 1.5px solid var(--border);
}
.legenda-table tr:nth-child(even) td { background: var(--cream); }
.legenda-table tr:last-child td { border-bottom: none; }

/* â”€â”€ FOOD ITEM CARD â”€â”€ */
.food-card {
  display: flex; align-items: center; gap: 12px;
  padding: 14px 18px;
  background: var(--white);
  border: 1.5px solid var(--border);
  border-radius: 12px;
  margin-bottom: 10px;
  transition: border-color 0.2s;
}
.food-card:hover { border-color: var(--green); }
.food-card .food-name { flex: 1; font-weight: 700; font-size: 14px; }

/* â”€â”€ DAILY MACRO BAR â”€â”€ */
.macro-summary {
  display: grid;
  grid-template-columns: repeat(4,1fr);
  gap: 12px;
  margin-bottom: 20px;
}
.macro-box {
  background: var(--card);
  border: 1.5px solid var(--border);
  border-radius: 12px;
  padding: 14px;
  text-align: center;
  box-shadow: var(--shadow);
}
.macro-box .mval { font-family: var(--font-brand); font-weight: 900; font-size: 22px; }
.macro-box .mlbl { font-family: var(--font-mono); font-size: 9px; color: var(--muted); letter-spacing: 1.5px; margin-top: 2px; }

@media (max-width: 768px) {
  .sidebar { width: 58px; }
  .main { margin-left: 58px; padding: 16px; }
  .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
  .macro-summary { grid-template-columns: 1fr 1fr; }
}

/* pulse animation */
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.7;transform:scale(1.12)} }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AUTH SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="auth-screen">
  <div class="auth-box">
    <!-- LOGO -->
    <div class="logo-wrap">
      <svg width="200" height="90" viewBox="0 0 200 90" xmlns="http://www.w3.org/2000/svg">
        <!-- Leaf -->
        <ellipse cx="100" cy="10" rx="7" ry="11" fill="#4a7a35" transform="rotate(-15 100 10)"/>
        <ellipse cx="100" cy="10" rx="7" ry="11" fill="#4a7a35" transform="rotate(15 100 10)"/>
        <line x1="100" y1="20" x2="100" y2="28" stroke="#4a7a35" stroke-width="1.5"/>
        <!-- NUTRI -->
        <text x="100" y="54" text-anchor="middle" font-family="Nunito,sans-serif" font-weight="900" font-size="42" fill="#4a7a35" letter-spacing="-1">NUTRI</text>
        <!-- TRACK -->
        <text x="100" y="85" text-anchor="middle" font-family="Nunito,sans-serif" font-weight="900" font-size="38" fill="#e07020" letter-spacing="-1">TRACK</text>
      </svg>
    </div>

    <!-- TABS -->
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">Accedi</button>
      <button class="auth-tab" onclick="switchAuthTab('register')">Registrati</button>
    </div>

    <!-- ERROR -->
    <div class="auth-error" id="auth-error"></div>

    <!-- LOGIN FORM -->
    <div class="auth-form" id="form-login">
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" id="login-email" placeholder="la-tua@email.com" autocomplete="email">
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" id="login-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
      </div>
      <button class="btn btn-green" onclick="doLogin()" id="login-btn">Accedi â†’</button>
      <div class="forgot-link" onclick="doForgot()">Password dimenticata?</div>
    </div>

    <!-- REGISTER FORM -->
    <div class="auth-form hidden" id="form-register">
      <div class="form-group">
        <label class="form-label">Nome</label>
        <input type="text" id="reg-name" placeholder="Il tuo nome">
      </div>
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" id="reg-email" placeholder="la-tua@email.com">
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" id="reg-pass" placeholder="Min. 6 caratteri" onkeydown="if(event.key==='Enter')doRegister()">
      </div>
      <button class="btn btn-orange" onclick="doRegister()" id="reg-btn">Crea account â†’</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     APP SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app-screen">

  <!-- SIDEBAR -->
  <nav class="sidebar">
    <div class="sidebar-logo">
      <span>NUTRI</span>
      <span>TRACK</span>
    </div>

    <button class="nav-btn active" id="nav-home" onclick="goPage('home')">
      <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      <span>HOME</span>
    </button>
    <button class="nav-btn" id="nav-diary" onclick="goPage('diary')">
      <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="8" y1="14" x2="16" y2="14"/><line x1="8" y1="18" x2="12" y2="18"/></svg>
      <span>DIARIO</span>
    </button>
    <button class="nav-btn" id="nav-foods" onclick="goPage('foods')">
      <svg viewBox="0 0 24 24"><path d="M12 2a3 3 0 013 3v1H9V5a3 3 0 013-3z"/><path d="M5 8h14l-1.5 10H6.5L5 8z"/><line x1="9" y1="13" x2="9" y2="17"/><line x1="12" y1="13" x2="12" y2="17"/><line x1="15" y1="13" x2="15" y2="17"/></svg>
      <span>ALIMENTI</span>
    </button>
    <button class="nav-btn" id="nav-goals" onclick="goPage('goals')">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
      <span>OBIETTIVI</span>
    </button>
    <button class="nav-btn" id="nav-legenda" onclick="goPage('legenda')">
      <svg viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>
      <span>LEGENDA</span>
    </button>
    <!-- Admin only -->
    <button class="nav-btn" id="nav-admin" onclick="goPage('admin')" style="display:none">
      <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
      <span>UTENTI</span>
    </button>

    <div class="sidebar-bottom">
      <div class="user-avatar" id="user-avatar" title="Profilo">?</div>
      <button class="logout-btn" onclick="doLogout()" title="Esci">
        <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      </button>
    </div>
  </nav>

  <main class="main">

    <!-- â•â•â• HOME PAGE â•â•â• -->
    <div class="page active" id="page-home">
      <div class="page-header">
        <div>
          <div class="page-title-tag">// dashboard</div>
          <h1 id="home-greeting">Ciao!</h1>
        </div>
        <div style="font-family:var(--font-mono);font-size:12px;color:var(--muted)" id="home-date"></div>
      </div>

      <!-- Reminder banner -->
      <div id="weight-banner" style="display:none"></div>

      <!-- Weight entry -->
      <div class="card" style="margin-bottom:20px;border-top:3px solid var(--green)">
        <div class="sec-header">
          <h3>âš–ï¸ Inserisci il peso di oggi</h3>
          <div id="weight-streak" style="font-family:var(--font-mono);font-size:12px;color:var(--muted)"></div>
        </div>
        <div class="weight-input-row">
          <input type="number" id="weight-today" placeholder="75.0" step="0.1" min="20" max="300">
          <span style="color:var(--muted);font-family:var(--font-mono);font-size:16px">kg</span>
          <button class="btn btn-green" onclick="saveWeight()">Salva peso</button>
        </div>
        <div style="margin-top:14px;display:flex;gap:16px;flex-wrap:wrap">
          <div><div style="font-family:var(--font-mono);font-size:9px;color:var(--muted);letter-spacing:1.5px;margin-bottom:2px">ULTIMO PESO</div>
            <div style="font-family:var(--font-brand);font-weight:900;font-size:22px;color:var(--green)" id="stat-last">â€”</div></div>
          <div><div style="font-family:var(--font-mono);font-size:9px;color:var(--muted);letter-spacing:1.5px;margin-bottom:2px">VARIAZIONE</div>
            <div style="font-family:var(--font-brand);font-weight:800;font-size:20px" id="stat-delta">â€”</div></div>
          <div><div style="font-family:var(--font-mono);font-size:9px;color:var(--muted);letter-spacing:1.5px;margin-bottom:2px">MEDIA SETT.</div>
            <div style="font-family:var(--font-brand);font-weight:900;font-size:22px" id="stat-weekly">â€”</div></div>
          <div><div style="font-family:var(--font-mono);font-size:9px;color:var(--muted);letter-spacing:1.5px;margin-bottom:2px">MEDIA MENS.</div>
            <div style="font-family:var(--font-brand);font-weight:900;font-size:22px" id="stat-monthly">â€”</div></div>
        </div>
      </div>

      <!-- Today's diary summary -->
      <div class="card" style="margin-bottom:20px;border-top:3px solid var(--orange)">
        <div class="sec-header">
          <h3>ğŸ½ï¸ Riepilogo dieta di oggi</h3>
          <button class="btn btn-ghost btn-sm" onclick="goPage('diary')">Apri Diario â†’</button>
        </div>
        <div class="macro-summary" id="home-macro-summary">
          <div class="macro-box"><div class="mval" style="color:var(--green)">0</div><div class="mlbl">KCAL</div></div>
          <div class="macro-box"><div class="mval" style="color:var(--orange)">0g</div><div class="mlbl">PROTEINE</div></div>
          <div class="macro-box"><div class="mval" style="color:#3b82f6">0g</div><div class="mlbl">CARBOIDRATI</div></div>
          <div class="macro-box"><div class="mval" style="color:#ca8a04">0g</div><div class="mlbl">GRASSI</div></div>
        </div>
        <div id="home-today-entries" style="color:var(--muted);font-size:13px;text-align:center;padding:8px 0">
          Nessun alimento registrato oggi.
        </div>
      </div>

      <!-- Chart -->
      <div class="card" style="margin-bottom:20px">
        <div class="sec-header"><h3>ğŸ“ˆ Andamento peso</h3>
          <div style="display:flex;gap:8px">
            <button class="btn btn-ghost btn-xs" onclick="setChartRange(30)" id="cr-30">30gg</button>
            <button class="btn btn-ghost btn-xs" onclick="setChartRange(90)" id="cr-90">3 mesi</button>
            <button class="btn btn-ghost btn-xs" onclick="setChartRange(99999)" id="cr-all">Tutto</button>
          </div>
        </div>
        <div class="chart-wrap"><canvas id="weight-chart"></canvas></div>
      </div>

      <!-- Weight History -->
      <div class="card" style="padding:0;overflow:hidden">
        <div style="padding:16px 22px;border-bottom:1.5px solid var(--border);display:flex;align-items:center;justify-content:space-between">
          <h3>ğŸ“‹ Storico misurazioni</h3>
          <span id="hist-count" style="font-family:var(--font-mono);font-size:11px;color:var(--muted)">0 misurazioni</span>
        </div>
        <div id="weight-history" style="max-height:380px;overflow-y:auto">
          <div class="empty"><div class="empty-icon">âš–ï¸</div><p>Nessuna misurazione ancora.</p></div>
        </div>
      </div>
    </div>

    <!-- â•â•â• DIARY PAGE â•â•â• -->
    <div class="page" id="page-diary">
      <div class="page-header">
        <div>
          <div class="page-title-tag">// diario alimentare</div>
          <h1>Diario</h1>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <input type="date" id="diary-date" style="width:160px" onchange="loadDiary()">
          <button class="btn btn-ghost btn-sm" onclick="setDiaryToday()">Oggi</button>
        </div>
      </div>

      <!-- Macro totals -->
      <div class="macro-summary" id="diary-macro-summary">
        <div class="macro-box"><div class="mval" style="color:var(--green)" id="d-kcal">0</div><div class="mlbl">KCAL</div></div>
        <div class="macro-box"><div class="mval" style="color:var(--orange)" id="d-prot">0g</div><div class="mlbl">PROTEINE</div></div>
        <div class="macro-box"><div class="mval" style="color:#3b82f6" id="d-carb">0g</div><div class="mlbl">CARBOIDRATI</div></div>
        <div class="macro-box"><div class="mval" style="color:#ca8a04" id="d-fat">0g</div><div class="mlbl">GRASSI</div></div>
      </div>

      <!-- Add food to diary -->
      <div class="card" style="margin-bottom:20px">
        <h3 style="margin-bottom:14px">â• Aggiungi alimento</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end">
          <div style="flex:2;min-width:200px">
            <div style="font-size:11px;color:var(--muted);margin-bottom:5px;font-family:var(--font-brand);font-weight:700">ALIMENTO</div>
            <div class="ac-wrap">
              <input type="text" id="diary-food-search" placeholder="Cerca nei tuoi alimenti o nel database..." oninput="searchDiaryFood()" autocomplete="off">
              <div class="ac-list" id="diary-ac"></div>
            </div>
          </div>
          <div style="width:100px">
            <div style="font-size:11px;color:var(--muted);margin-bottom:5px;font-family:var(--font-brand);font-weight:700">GRAMMI</div>
            <input type="number" id="diary-grams" placeholder="100" value="100" min="1" max="5000">
          </div>
          <button class="btn btn-green" onclick="addToDiary()">Aggiungi</button>
        </div>
      </div>

      <!-- Diary entries -->
      <div class="card" style="padding:0;overflow:hidden">
        <div style="padding:14px 22px;border-bottom:1.5px solid var(--border)">
          <h3>Alimenti di oggi</h3>
        </div>
        <div id="diary-entries" style="padding:16px">
          <div class="empty"><div class="empty-icon">ğŸ½ï¸</div><p>Nessun alimento nel diario di oggi.</p></div>
        </div>
      </div>
    </div>

    <!-- â•â•â• FOODS PAGE â•â•â• -->
    <div class="page" id="page-foods">
      <div class="page-header">
        <div>
          <div class="page-title-tag">// database personale</div>
          <h1>I Miei Alimenti</h1>
        </div>
        <button class="btn btn-green" onclick="openFoodModal()">â• Nuovo alimento</button>
      </div>

      <div class="card" style="margin-bottom:16px;padding:14px 18px">
        <input type="text" id="foods-search" placeholder="ğŸ”  Cerca nei tuoi alimenti..." oninput="filterFoods()" style="border:none;background:transparent;font-size:15px;padding:0;box-shadow:none">
      </div>

      <div id="foods-list">
        <div class="empty"><div class="empty-icon">ğŸ¥—</div><p>Nessun alimento creato ancora.<br>Inizia aggiungendo i tuoi alimenti preferiti!</p></div>
      </div>
    </div>

    <!-- â•â•â• GOALS PAGE â•â•â• -->
    <div class="page" id="page-goals">
      <div class="page-header">
        <div>
          <div class="page-title-tag">// il tuo obiettivo</div>
          <h1>Obiettivo Peso</h1>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <div class="card" style="margin-bottom:20px">
            <h3 style="margin-bottom:16px">ğŸ¯ Imposta obiettivo</h3>
            <div style="display:flex;flex-direction:column;gap:14px">
              <div>
                <div class="form-label" style="margin-bottom:5px">PESO DI PARTENZA (kg)</div>
                <input type="number" id="goal-start" step="0.1" placeholder="es. 85">
              </div>
              <div>
                <div class="form-label" style="margin-bottom:5px">PESO OBIETTIVO (kg)</div>
                <input type="number" id="goal-target" step="0.1" placeholder="es. 75">
              </div>
              <div>
                <div class="form-label" style="margin-bottom:5px">NOTE / STRATEGIA</div>
                <textarea id="goal-note" placeholder="Es: -0.5 kg/settimana, deficit 400 kcal..."></textarea>
              </div>
              <button class="btn btn-green" onclick="saveGoal()">Salva obiettivo</button>
            </div>
          </div>
        </div>
        <div id="goal-progress-card">
          <div class="card">
            <div class="empty"><div class="empty-icon">ğŸ¯</div><p>Imposta il tuo obiettivo per vedere i progressi.</p></div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â• LEGENDA PAGE â•â•â• -->
    <div class="page" id="page-legenda">
      <div class="page-header">
        <div>
          <div class="page-title-tag">// riferimento rapido</div>
          <h1>Legenda & Conversioni</h1>
        </div>
      </div>

      <div class="grid-2" style="gap:20px">

        <!-- Misure cucina -->
        <div class="card">
          <h3 style="margin-bottom:16px">ğŸ¥„ Misure in Cucina</h3>
          <table class="legenda-table" style="border-radius:10px;overflow:hidden">
            <thead><tr><th>Misura</th><th>ml</th><th>~ grammi</th></tr></thead>
            <tbody>
              <tr><td>1 cucchiaino (tsp)</td><td>5 ml</td><td>~5g</td></tr>
              <tr><td>1 cucchiaio (tbsp)</td><td>15 ml</td><td>~15g</td></tr>
              <tr><td>1 tazza (cup USA)</td><td>240 ml</td><td>~240g acqua</td></tr>
              <tr><td>1 tazza farina</td><td>240 ml</td><td>~120g</td></tr>
              <tr><td>1 tazza riso crudo</td><td>240 ml</td><td>~185g</td></tr>
              <tr><td>1 tazza avena</td><td>240 ml</td><td>~90g</td></tr>
              <tr><td>1 cucchiaio olio EVO</td><td>15 ml</td><td>~14g = 124 kcal</td></tr>
              <tr><td>1 cucchiaio burro</td><td>15 ml</td><td>~14g = 100 kcal</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Porzioni comuni -->
        <div class="card">
          <h3 style="margin-bottom:16px">ğŸ³ Porzioni di Riferimento</h3>
          <table class="legenda-table" style="border-radius:10px;overflow:hidden">
            <thead><tr><th>Alimento</th><th>1 porzione</th><th>kcal ~</th></tr></thead>
            <tbody>
              <tr><td>Uovo M di gallina</td><td>~55 g</td><td>~85 kcal</td></tr>
              <tr><td>Petto pollo cotto</td><td>~150 g</td><td>~248 kcal</td></tr>
              <tr><td>Pasta cruda</td><td>80 g</td><td>~282 kcal</td></tr>
              <tr><td>Riso crudo</td><td>80 g</td><td>~270 kcal</td></tr>
              <tr><td>Pane bianco</td><td>50 g</td><td>~136 kcal</td></tr>
              <tr><td>Banana media</td><td>~120 g</td><td>~107 kcal</td></tr>
              <tr><td>Mela media</td><td>~180 g</td><td>~94 kcal</td></tr>
              <tr><td>Yogurt greco 0%</td><td>150 g</td><td>~89 kcal</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Macro per kcal -->
        <div class="card">
          <h3 style="margin-bottom:16px">âš¡ Calorie per Macronutriente</h3>
          <table class="legenda-table" style="border-radius:10px;overflow:hidden">
            <thead><tr><th>Nutriente</th><th>kcal/g</th><th>Funzione principale</th></tr></thead>
            <tbody>
              <tr><td>ğŸ¥© Proteine</td><td style="color:var(--orange);font-weight:700">4 kcal/g</td><td>Costruzione muscolare</td></tr>
              <tr><td>ğŸ Carboidrati</td><td style="color:#3b82f6;font-weight:700">4 kcal/g</td><td>Energia principale</td></tr>
              <tr><td>ğŸ«’ Grassi</td><td style="color:#ca8a04;font-weight:700">9 kcal/g</td><td>Ormoni, vitamine</td></tr>
              <tr><td>ğŸº Alcol</td><td style="color:var(--danger);font-weight:700">7 kcal/g</td><td>â€”</td></tr>
            </tbody>
          </table>
        </div>

        <!-- BMI -->
        <div class="card">
          <h3 style="margin-bottom:16px">ğŸ“Š Tabella BMI</h3>
          <table class="legenda-table" style="border-radius:10px;overflow:hidden">
            <thead><tr><th>Categoria</th><th>BMI</th></tr></thead>
            <tbody>
              <tr><td>Sottopeso</td><td>&lt; 18.5</td></tr>
              <tr><td>Normopeso</td><td>18.5 â€“ 24.9</td></tr>
              <tr><td>Sovrappeso</td><td>25.0 â€“ 29.9</td></tr>
              <tr><td>ObesitÃ  Classe I</td><td>30.0 â€“ 34.9</td></tr>
              <tr><td>ObesitÃ  Classe II</td><td>35.0 â€“ 39.9</td></tr>
              <tr><td>ObesitÃ  Classe III</td><td>â‰¥ 40.0</td></tr>
            </tbody>
          </table>
          <div style="margin-top:14px;padding:12px 16px;background:var(--cream);border-radius:10px">
            <div style="font-size:11px;color:var(--muted);margin-bottom:6px;font-family:var(--font-brand);font-weight:700">CALCOLA IL TUO BMI</div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <input type="number" id="bmi-weight" placeholder="Peso (kg)" style="width:120px" oninput="calcBMI()">
              <input type="number" id="bmi-height" placeholder="Altezza (cm)" style="width:130px" oninput="calcBMI()">
              <div id="bmi-result" style="font-family:var(--font-brand);font-weight:900;font-size:20px;color:var(--green)"></div>
            </div>
          </div>
        </div>

        <!-- Fabbisogno calorico -->
        <div class="card">
          <h3 style="margin-bottom:16px">ğŸ”¥ Fabbisogno Calorico (TDEE)</h3>
          <table class="legenda-table" style="border-radius:10px;overflow:hidden">
            <thead><tr><th>Livello AttivitÃ </th><th>Moltiplicatore BMR</th></tr></thead>
            <tbody>
              <tr><td>Sedentario (poco/nessun esercizio)</td><td>Ã— 1.2</td></tr>
              <tr><td>Leggero (1-3 gg/sett.)</td><td>Ã— 1.375</td></tr>
              <tr><td>Moderato (3-5 gg/sett.)</td><td>Ã— 1.55</td></tr>
              <tr><td>Attivo (6-7 gg/sett.)</td><td>Ã— 1.725</td></tr>
              <tr><td>Molto attivo (2x/giorno)</td><td>Ã— 1.9</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Conversioni peso -->
        <div class="card">
          <h3 style="margin-bottom:16px">âš–ï¸ Conversioni Peso & Volume</h3>
          <table class="legenda-table" style="border-radius:10px;overflow:hidden">
            <thead><tr><th>Da</th><th>A</th><th>Valore</th></tr></thead>
            <tbody>
              <tr><td>1 kg</td><td>grammi</td><td>1.000 g</td></tr>
              <tr><td>1 kg</td><td>libbre (lb)</td><td>2.205 lb</td></tr>
              <tr><td>1 lb</td><td>grammi</td><td>453.6 g</td></tr>
              <tr><td>1 oz (oncia)</td><td>grammi</td><td>28.35 g</td></tr>
              <tr><td>1 litro</td><td>ml</td><td>1.000 ml</td></tr>
              <tr><td>1 kcal</td><td>kJ</td><td>4.184 kJ</td></tr>
              <tr><td>100 kJ</td><td>kcal</td><td>23.9 kcal</td></tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>

    <!-- â•â•â• ADMIN PAGE â•â•â• -->
    <div class="page" id="page-admin">
      <div class="page-header">
        <div>
          <div class="page-title-tag">// pannello amministratore</div>
          <h1>Gestione Utenti</h1>
        </div>
        <div id="admin-user-count" style="font-family:var(--font-mono);font-size:13px;color:var(--muted)"></div>
      </div>

      <!-- User detail view (hidden by default) -->
      <div id="admin-user-detail" style="display:none">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px">
          <button class="btn btn-ghost btn-sm" onclick="closeUserDetail()">â† Torna alla lista</button>
          <h2 id="admin-detail-name"></h2>
        </div>
        <div class="card" style="margin-bottom:20px">
          <div class="sec-header"><h3>ğŸ“ˆ Andamento peso</h3></div>
          <div class="chart-wrap"><canvas id="admin-chart"></canvas></div>
        </div>
        <div class="grid-3" style="margin-bottom:20px">
          <div class="stat-chip"><div class="val" id="adm-last" style="color:var(--green)">â€”</div><div class="lbl">ULTIMO PESO</div></div>
          <div class="stat-chip"><div class="val" id="adm-weekly">â€”</div><div class="lbl">MEDIA SETT.</div></div>
          <div class="stat-chip"><div class="val" id="adm-monthly">â€”</div><div class="lbl">MEDIA MENS.</div></div>
        </div>
        <div class="card" style="padding:0;overflow:hidden">
          <div style="padding:14px 22px;border-bottom:1.5px solid var(--border)"><h3>Storico pesi</h3></div>
          <div id="admin-weight-list" style="max-height:300px;overflow-y:auto"></div>
        </div>
      </div>

      <!-- User list -->
      <div id="admin-user-list">
        <div class="card" style="padding:0;overflow:hidden">
          <table class="admin-table">
            <thead><tr><th>NOME</th><th>EMAIL</th><th>RUOLO</th><th>REGISTRATO</th><th>ULTIMO PESO</th><th></th></tr></thead>
            <tbody id="admin-tbody">
              <tr><td colspan="6" style="text-align:center;padding:32px;color:var(--muted)">Caricamento...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FOOD MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="food-modal">
  <div class="modal-box">
    <div class="modal-header">
      <h2 id="food-modal-title">Nuovo Alimento</h2>
      <button class="btn btn-ghost btn-icon" onclick="closeFoodModal()">âœ•</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:14px">
      <div>
        <div class="form-label" style="margin-bottom:5px">NOME ALIMENTO *</div>
        <input type="text" id="fm-name" placeholder="Es. RagÃ¹ della nonna">
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <div class="form-label" style="margin-bottom:5px">KCAL (per 100g) *</div>
          <input type="number" id="fm-kcal" placeholder="es. 250" step="0.1" oninput="updateFoodModalMacros()">
        </div>
        <div>
          <div class="form-label" style="margin-bottom:5px">PROTEINE (g/100g)</div>
          <input type="number" id="fm-prot" placeholder="es. 25" step="0.1" oninput="updateFoodModalMacros()">
        </div>
        <div>
          <div class="form-label" style="margin-bottom:5px">CARBOIDRATI (g/100g)</div>
          <input type="number" id="fm-carb" placeholder="es. 50" step="0.1" oninput="updateFoodModalMacros()">
        </div>
        <div>
          <div class="form-label" style="margin-bottom:5px">GRASSI (g/100g)</div>
          <input type="number" id="fm-fat" placeholder="es. 20" step="0.1" oninput="updateFoodModalMacros()">
        </div>
      </div>
      <div style="padding:12px 16px;background:var(--cream);border-radius:10px;display:flex;gap:10px;flex-wrap:wrap" id="fm-preview" style="display:none">
        <span class="macro-pill mp-kcal" id="fmp-kcal">0 kcal</span>
        <span class="macro-pill mp-prot" id="fmp-prot">P 0g</span>
        <span class="macro-pill mp-carb" id="fmp-carb">C 0g</span>
        <span class="macro-pill mp-fat"  id="fmp-fat">G 0g</span>
        <span style="font-family:var(--font-mono);font-size:10px;color:var(--muted)">per 100g</span>
      </div>
      <div>
        <div class="form-label" style="margin-bottom:5px">NOTE (opzionale)</div>
        <textarea id="fm-notes" placeholder="Es. Ricetta casalinga, valori stimati..." style="min-height:60px"></textarea>
      </div>
      <input type="hidden" id="fm-edit-id">
      <div style="display:flex;gap:10px">
        <button class="btn btn-ghost" onclick="closeFoodModal()" style="flex:1">Annulla</button>
        <button class="btn btn-green" onclick="saveFoodItem()" style="flex:2">Salva alimento</button>
      </div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast"><div class="t-dot"></div><span id="toast-msg">Salvato!</span></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     INRAN FOOD DATABASE (per 100g)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REGOLE FIRESTORE â€” incolla queste nella Firebase Console
   (Firestore â†’ Regole) per far funzionare tutto correttamente:

   rules_version = '2';
   service cloud.firestore {
     match /databases/{database}/documents {

       // Chiunque autenticato puÃ² leggere la lista utenti (serve all'admin)
       match /users/{userId} {
         allow read: if request.auth != null;
         allow create: if request.auth.uid == userId;
         allow update, delete: if request.auth.uid == userId;

         // Ogni utente accede solo ai propri dati
         match /{subcollection}/{docId} {
           allow read, write: if request.auth.uid == userId;
         }
       }
     }
   }
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•= */

const INRAN = [
  {n:"Petto di pollo cotto",cat:"Carne",kcal:165,p:31,c:0,f:3.6},
  {n:"Petto di pollo crudo",cat:"Carne",kcal:110,p:23.1,c:0,f:1.2},
  {n:"Coscia di pollo cotta",cat:"Carne",kcal:197,p:27,c:0,f:10},
  {n:"Tacchino, fesa cotta",cat:"Carne",kcal:157,p:30,c:0,f:3.9},
  {n:"Manzo, fesa cruda",cat:"Carne",kcal:107,p:21,c:0,f:2.5},
  {n:"Manzo, macinato",cat:"Carne",kcal:246,p:17.2,c:0,f:20},
  {n:"Vitello, fesa cruda",cat:"Carne",kcal:109,p:21,c:0,f:2.8},
  {n:"Maiale, lonza cruda",cat:"Carne",kcal:162,p:20.7,c:0,f:9},
  {n:"Salmone fresco",cat:"Pesce",kcal:208,p:20,c:0,f:13.6},
  {n:"Tonno al naturale",cat:"Pesce",kcal:103,p:23,c:0,f:1},
  {n:"Merluzzo",cat:"Pesce",kcal:82,p:18,c:0,f:0.7},
  {n:"Orata",cat:"Pesce",kcal:121,p:21,c:0,f:4},
  {n:"Branzino",cat:"Pesce",kcal:88,p:18.7,c:0,f:1.6},
  {n:"Gamberetti",cat:"Pesce",kcal:99,p:20,c:0.9,f:1.7},
  {n:"Polpo",cat:"Pesce",kcal:57,p:12.6,c:0.6,f:0.5},
  {n:"Uovo intero",cat:"Uova",kcal:155,p:12.5,c:0.7,f:11.1},
  {n:"Albume",cat:"Uova",kcal:43,p:11,c:0.7,f:0},
  {n:"Tuorlo",cat:"Uova",kcal:352,p:16.3,c:0.3,f:31.9},
  {n:"Latte intero",cat:"Latticini",kcal:64,p:3.3,c:4.9,f:3.6},
  {n:"Latte scremato",cat:"Latticini",kcal:35,p:3.6,c:5,f:0.2},
  {n:"Yogurt greco 0%",cat:"Latticini",kcal:59,p:10.2,c:3.6,f:0.4},
  {n:"Yogurt greco intero",cat:"Latticini",kcal:115,p:9,c:3.8,f:7.7},
  {n:"Ricotta vaccina",cat:"Latticini",kcal:146,p:11,c:3,f:10.2},
  {n:"Fiocchi di latte",cat:"Latticini",kcal:72,p:12.5,c:3,f:0.5},
  {n:"Mozzarella vaccina",cat:"Latticini",kcal:254,p:18,c:2.2,f:20},
  {n:"Parmigiano Reggiano",cat:"Latticini",kcal:431,p:33,c:0,f:29.7},
  {n:"Bresaola",cat:"Salumi",kcal:143,p:29,c:0.8,f:2.3},
  {n:"Prosciutto crudo sgrassato",cat:"Salumi",kcal:145,p:27.5,c:0,f:4.5},
  {n:"Prosciutto cotto",cat:"Salumi",kcal:215,p:21,c:0.9,f:14},
  {n:"Mortadella",cat:"Salumi",kcal:311,p:14.7,c:1.5,f:28.1},
  {n:"Pasta di semola cruda",cat:"Cereali",kcal:353,p:12.5,c:71.5,f:1.5},
  {n:"Pasta di semola cotta",cat:"Cereali",kcal:158,p:5.8,c:30.9,f:0.9},
  {n:"Pasta integrale cotta",cat:"Cereali",kcal:124,p:5.3,c:25,f:1.2},
  {n:"Riso bianco crudo",cat:"Cereali",kcal:337,p:6.7,c:78.4,f:0.4},
  {n:"Riso bianco cotto",cat:"Cereali",kcal:138,p:2.9,c:31.4,f:0.3},
  {n:"Riso integrale cotto",cat:"Cereali",kcal:111,p:2.6,c:23,f:0.9},
  {n:"Avena, fiocchi",cat:"Cereali",kcal:389,p:16.9,c:66.3,f:6.9},
  {n:"Quinoa cotta",cat:"Cereali",kcal:120,p:4.4,c:21.3,f:1.9},
  {n:"Pane bianco",cat:"Cereali",kcal:271,p:9,c:55.4,f:0.5},
  {n:"Pane integrale",cat:"Cereali",kcal:243,p:9.5,c:48,f:3.2},
  {n:"Fette biscottate",cat:"Cereali",kcal:411,p:10.6,c:81,f:4.9},
  {n:"Patata bollita",cat:"Verdure",kcal:77,p:2,c:17.5,f:0.1},
  {n:"Patata dolce cotta",cat:"Verdure",kcal:90,p:2,c:20.7,f:0.1},
  {n:"Spinaci crudi",cat:"Verdure",kcal:23,p:2.9,c:3.6,f:0.4},
  {n:"Broccoli",cat:"Verdure",kcal:34,p:2.8,c:7,f:0.4},
  {n:"Zucchine",cat:"Verdure",kcal:17,p:1.2,c:3.1,f:0.3},
  {n:"Pomodori",cat:"Verdure",kcal:18,p:0.9,c:3.9,f:0.2},
  {n:"Insalata lattuga",cat:"Verdure",kcal:14,p:1.3,c:2.2,f:0.2},
  {n:"Carote",cat:"Verdure",kcal:41,p:0.9,c:9.6,f:0.2},
  {n:"Peperoni",cat:"Verdure",kcal:31,p:1,c:6,f:0.3},
  {n:"Cetrioli",cat:"Verdure",kcal:15,p:0.6,c:3.6,f:0.1},
  {n:"Asparagi",cat:"Verdure",kcal:20,p:2.2,c:3.9,f:0.1},
  {n:"Funghi champignon",cat:"Verdure",kcal:22,p:3.1,c:3.3,f:0.3},
  {n:"Ceci cotti",cat:"Legumi",kcal:164,p:8.9,c:27.4,f:2.6},
  {n:"Lenticchie cotte",cat:"Legumi",kcal:116,p:9,c:20.1,f:0.4},
  {n:"Fagioli cannellini cotti",cat:"Legumi",kcal:122,p:7.9,c:23,f:0.4},
  {n:"Edamame",cat:"Legumi",kcal:121,p:11,c:8.9,f:5.2},
  {n:"Tofu",cat:"Legumi",kcal:76,p:8,c:1.9,f:4.8},
  {n:"Mela",cat:"Frutta",kcal:52,p:0.3,c:13.8,f:0.2},
  {n:"Banana",cat:"Frutta",kcal:89,p:1.1,c:22.8,f:0.3},
  {n:"Arancia",cat:"Frutta",kcal:47,p:0.9,c:11.7,f:0.1},
  {n:"Fragole",cat:"Frutta",kcal:32,p:0.7,c:7.7,f:0.3},
  {n:"Kiwi",cat:"Frutta",kcal:61,p:1.1,c:14.7,f:0.5},
  {n:"Avocado",cat:"Frutta",kcal:160,p:2,c:8.5,f:14.7},
  {n:"Mandorle",cat:"Frutta Secca",kcal:597,p:21.2,c:21.7,f:52.5},
  {n:"Noci",cat:"Frutta Secca",kcal:654,p:15.2,c:13.7,f:65.2},
  {n:"Olio EVO",cat:"Condimenti",kcal:884,p:0,c:0,f:100},
  {n:"Burro",cat:"Condimenti",kcal:717,p:0.9,c:0.1,f:81.1},
  {n:"Whey protein",cat:"Integratori",kcal:380,p:80,c:7,f:4},
  {n:"Caseina",cat:"Integratori",kcal:375,p:82,c:5,f:2},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let weightData = [];
let userFoods  = [];
let diaryEntries = [];
let goalData   = null;
let weightChart = null;
let adminChart  = null;
let chartRange  = 30;
let currentDiaryDate = '';
let selectedDiaryFood = null;
let editingFoodId = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  const nb = document.getElementById('nav-'+id);
  if (nb) nb.classList.add('active');
  if (id === 'admin') loadAdminUsers();
  if (id === 'goals') loadGoal();
  if (id === 'diary') { setDiaryToday(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach((t,i) => {
    t.classList.toggle('active', (i===0&&tab==='login')||(i===1&&tab==='register'));
  });
  document.getElementById('form-login').classList.toggle('hidden', tab!=='login');
  document.getElementById('form-register').classList.toggle('hidden', tab!=='register');
  clearAuthError();
}

function showAuthError(msg) {
  const el = document.getElementById('auth-error');
  el.textContent = msg; el.style.display = 'block';
}
function clearAuthError() { document.getElementById('auth-error').style.display = 'none'; }

async function doLogin() {
  const email = document.getElementById('login-email').value.trim();
  const pass  = document.getElementById('login-pass').value;
  if (!email||!pass) { showAuthError('Inserisci email e password.'); return; }
  const btn = document.getElementById('login-btn');
  btn.disabled = true; btn.textContent = 'Accesso...';
  try {
    await window._fb.signInWithEmailAndPassword(window._fb.auth, email, pass);
  } catch(e) {
    showAuthError(firebaseErrMsg(e.code));
    btn.disabled = false; btn.textContent = 'Accedi â†’';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CREDENZIALI ADMIN â€” modifica qui
const ADMIN_EMAIL = 'admin@nutritrack.it';
// Crea l'account admin registrandoti con questa email.
// Solo chi accede con questa email vedrÃ  il pannello utenti.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function doRegister() {
  const name  = document.getElementById('reg-name').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const pass  = document.getElementById('reg-pass').value;
  if (!name||!email||!pass) { showAuthError('Compila tutti i campi.'); return; }
  if (pass.length < 6) { showAuthError('Password minimo 6 caratteri.'); return; }
  const isAdmin = email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
  const btn = document.getElementById('reg-btn');
  btn.disabled = true; btn.textContent = 'Registrazione...';
  try {
    const {auth, db, createUserWithEmailAndPassword, doc, setDoc} = window._fb;
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    // Ruolo determinato esclusivamente dall'email, non dall'ordine di registrazione
    const role = isAdmin ? 'admin' : 'user';
    await setDoc(doc(db,'users', cred.user.uid), {
      name, email, role, createdAt: Date.now()
    });
  } catch(e) {
    showAuthError(firebaseErrMsg(e.code));
    btn.disabled = false; btn.textContent = 'Crea account â†’';
  }
}

async function doForgot() {
  const email = document.getElementById('login-email').value.trim();
  if (!email) { showAuthError('Inserisci la tua email nel campo sopra.'); return; }
  try {
    await window._fb.sendPasswordResetEmail(window._fb.auth, email);
    showAuthError('âœ… Email di recupero inviata!');
    document.getElementById('auth-error').style.background = 'var(--green-bg)';
    document.getElementById('auth-error').style.color = 'var(--green)';
    document.getElementById('auth-error').style.borderColor = 'rgba(74,122,53,0.3)';
  } catch(e) { showAuthError(firebaseErrMsg(e.code)); }
}

async function doLogout() {
  await window._fb.signOut(window._fb.auth);
}

function firebaseErrMsg(code) {
  const map = {
    'auth/user-not-found': 'Nessun account trovato con questa email.',
    'auth/wrong-password': 'Password errata.',
    'auth/invalid-email': 'Email non valida.',
    'auth/email-already-in-use': 'Email giÃ  in uso.',
    'auth/weak-password': 'Password troppo debole (min. 6 caratteri).',
    'auth/invalid-credential': 'Credenziali non valide.',
    'auth/too-many-requests': 'Troppi tentativi. Riprova piÃ¹ tardi.',
  };
  return map[code] || 'Errore: ' + code;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHOW / HIDE SCREENS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showAuth() {
  document.getElementById('auth-screen').style.display = 'flex';
  document.getElementById('app-screen').style.display = 'none';
}

function showApp() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app-screen').style.display = 'block';
  const u = window._currentUser;
  // Avatar & greeting
  const initials = (u.name||u.email).slice(0,2).toUpperCase();
  document.getElementById('user-avatar').textContent = initials;
  document.getElementById('home-greeting').textContent = 'Ciao, ' + (u.name||u.email.split('@')[0]) + '!';
  document.getElementById('home-date').textContent = new Date().toLocaleDateString('it-IT',{weekday:'long',day:'numeric',month:'long'});
  // Admin nav â€” doppio controllo: ruolo Firestore E email corrispondente
  const isAdmin = u.role === 'admin' || (u.email && u.email.toLowerCase() === ADMIN_EMAIL.toLowerCase());
  if (isAdmin) {
    document.getElementById('nav-admin').style.display = 'flex';
    // Se l'email Ã¨ admin ma il ruolo non Ã¨ stato salvato correttamente, aggiornalo
    if (u.role !== 'admin') {
      const {db, doc, updateDoc} = window._fb;
      updateDoc(doc(db,'users', u.uid), { role: 'admin' }).catch(()=>{});
      window._currentUser.role = 'admin';
    }
  }
  // Init
  initChart();
  setChartRange(30);
  setDiaryToday();
  subscribeWeights();
  loadUserFoods();
  loadGoal();
  updateHomeDiarySummary();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg, color='var(--green)') {
  const t = document.getElementById('toast');
  t.querySelector('.t-dot').style.background = color;
  document.getElementById('toast-msg').textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function todayStr() { return new Date().toISOString().split('T')[0]; }
function formatDate(str) {
  return new Date(str+'T00:00:00').toLocaleDateString('it-IT',{day:'2-digit',month:'short',year:'numeric'});
}
function uid() { return window._currentUser?.uid; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEIGHT â€” SUBSCRIBE (realtime)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function subscribeWeights() {
  const {db, collection, query, orderBy, onSnapshot} = window._fb;
  onSnapshot(
    query(collection(db,'users',uid(),'weights'), orderBy('date','asc')),
    snap => {
      weightData = snap.docs.map(d => ({id:d.id,...d.data()}));
      updateWeightUI();
    }
  );
}

async function saveWeight() {
  const val = parseFloat(document.getElementById('weight-today').value);
  if (!val||val<20||val>300) { toast('Peso non valido!','var(--danger)'); return; }
  const {db, doc, setDoc} = window._fb;
  const today = todayStr();
  await setDoc(doc(db,'users',uid(),'weights',today), {
    weight: val, date: today, ts: Date.now()
  });
  document.getElementById('weight-today').value = '';
  toast('Peso salvato: '+val+' kg');
}

async function deleteWeight(dateId) {
  if (!confirm('Eliminare questa misurazione?')) return;
  const {db, doc, deleteDoc} = window._fb;
  await deleteDoc(doc(db,'users',uid(),'weights',dateId));
  toast('Misurazione eliminata','var(--danger)');
}

async function confirmWeightEdit(dateId) {
  const inp = document.getElementById('we-'+dateId);
  if (!inp) return;
  const val = parseFloat(inp.value);
  if (!val||val<20||val>300) { toast('Peso non valido!','var(--danger)'); return; }
  const {db, doc, updateDoc} = window._fb;
  await updateDoc(doc(db,'users',uid(),'weights',dateId), { weight: val });
  toast('Peso aggiornato!');
}

function startWeightEdit(dateId, current) {
  document.getElementById('wd-'+dateId).style.display = 'none';
  document.getElementById('we-row-'+dateId).style.display = 'flex';
  const inp = document.getElementById('we-'+dateId);
  if (inp) { inp.focus(); inp.select(); }
}
function cancelWeightEdit(dateId) {
  document.getElementById('wd-'+dateId).style.display = 'flex';
  document.getElementById('we-row-'+dateId).style.display = 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEIGHT UI UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateWeightUI() {
  const today = todayStr();
  const hasToday = weightData.some(w => w.date === today);

  // Banner
  const banner = document.getElementById('weight-banner');
  if (!hasToday && weightData.length >= 0) {
    banner.style.display = 'flex';
    banner.className = 'banner banner-warn';
    banner.innerHTML = '<span style="font-size:22px;animation:pulse 2s infinite">âš–ï¸</span><div><div style="font-weight:700;color:var(--orange)">Ricordati di pesarti oggi!</div><div style="font-size:13px;color:var(--muted)">Non hai ancora registrato il peso di oggi.</div></div>';
  } else if (hasToday) {
    banner.style.display = 'flex';
    banner.className = 'banner banner-ok';
    banner.innerHTML = '<span style="font-size:20px">âœ…</span><div><div style="font-weight:700;color:var(--green)">Peso registrato oggi</div><div style="font-size:13px;color:var(--muted)">Ottimo lavoro, continua cosÃ¬!</div></div>';
  }

  // Stats
  if (weightData.length) {
    const sorted = [...weightData].sort((a,b)=>b.date.localeCompare(a.date));
    const last = sorted[0].weight;
    document.getElementById('stat-last').textContent = last.toFixed(1)+' kg';
    // Delta
    if (sorted.length>1) {
      const diff = (last - sorted[1].weight);
      const el = document.getElementById('stat-delta');
      el.textContent = (diff>0?'â†‘ +':'â†“ ')+diff.toFixed(1)+' kg';
      el.style.color = diff>0?'var(--danger)':'var(--green)';
    }
    // Weekly avg
    const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate()-7);
    const wk = weightData.filter(w=>new Date(w.date+'T00:00:00')>=weekAgo);
    if (wk.length) document.getElementById('stat-weekly').textContent = (wk.reduce((a,b)=>a+b.weight,0)/wk.length).toFixed(1)+' kg';
    // Monthly avg
    const mo = todayStr().slice(0,7);
    const mm = weightData.filter(w=>w.date.startsWith(mo));
    if (mm.length) document.getElementById('stat-monthly').textContent = (mm.reduce((a,b)=>a+b.weight,0)/mm.length).toFixed(1)+' kg';
  }

  // Streak
  const streak = computeStreak(weightData);
  document.getElementById('weight-streak').textContent = streak>1?'ğŸ”¥ '+streak+' giorni consecutivi':streak===1?'âœ… Streak iniziata!':'';

  // Chart
  updateChart();

  // History
  renderWeightHistory();

  // Aggiorna progressi obiettivo se la pagina Ã¨ aperta
  if (document.getElementById('page-goals') && document.getElementById('page-goals').classList.contains('active')) {
    renderGoalProgress();
  }
}

function computeStreak(data) {
  if (!data.length) return 0;
  const dates = [...new Set(data.map(d=>d.date))].sort((a,b)=>b.localeCompare(a));
  let streak=0, cursor=new Date(); cursor.setHours(0,0,0,0);
  for (const d of dates) {
    const dd = new Date(d+'T00:00:00');
    const diff = Math.round((cursor-dd)/86400000);
    if (diff===0||diff===1) { streak++; cursor=dd; } else break;
  }
  return streak;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initChart() {
  const ctx = document.getElementById('weight-chart').getContext('2d');
  weightChart = new Chart(ctx, {
    type: 'line',
    data: { labels:[], datasets:[{
      label:'Peso', data:[],
      borderColor:'#4a7a35', backgroundColor:'rgba(74,122,53,0.08)',
      fill:true, tension:0.4,
      pointBackgroundColor:'#4a7a35', pointRadius:4, pointHoverRadius:6
    }]},
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        tooltip:{
          backgroundColor:'#fff', borderColor:'#ddd6c8', borderWidth:1.5,
          titleColor:'#9a8f85', bodyColor:'#2a2420',
          callbacks:{ label: ctx=>' '+ctx.raw+' kg' }
        }
      },
      scales:{
        x:{ grid:{color:'rgba(0,0,0,0.05)'}, ticks:{color:'#9a8f85',font:{family:'DM Mono',size:10}} },
        y:{ grid:{color:'rgba(0,0,0,0.05)'}, ticks:{color:'#9a8f85',font:{family:'DM Mono',size:10}, callback:v=>v+' kg'} }
      }
    }
  });
}

function setChartRange(days) {
  chartRange = days;
  ['30','90','all'].forEach(r => {
    document.getElementById('cr-'+r).className = 'btn btn-ghost btn-xs';
  });
  const map = {30:'30',90:'90',365:'all'};
  if(document.getElementById('cr-'+map[days]))
    document.getElementById('cr-'+map[days]).className = 'btn btn-green btn-xs';
  updateChart();
}

function updateChart() {
  if (!weightChart) return;
  const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-chartRange);
  const filtered = weightData.filter(w=>new Date(w.date+'T00:00:00')>=cutoff);
  weightChart.data.labels = filtered.map(w=>new Date(w.date+'T00:00:00').toLocaleDateString('it-IT',{day:'2-digit',month:'short'}));
  weightChart.data.datasets[0].data = filtered.map(w=>w.weight);
  weightChart.update();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEIGHT HISTORY RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderWeightHistory() {
  const el = document.getElementById('weight-history');
  const cnt = document.getElementById('hist-count');
  if (!el) return;
  cnt.textContent = weightData.length+' misurazion'+(weightData.length===1?'e':'i');
  if (!weightData.length) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">âš–ï¸</div><p>Nessuna misurazione ancora.</p></div>';
    return;
  }
  const sorted = [...weightData].sort((a,b)=>b.date.localeCompare(a.date));
  el.innerHTML = sorted.map((w,i)=>{
    const isToday = w.date===todayStr();
    const prev = sorted[i+1];
    let deltaHtml='';
    if(prev){
      const d=(w.weight-prev.weight).toFixed(1);
      const v=parseFloat(d);
      const col=v>0?'var(--danger)':v<0?'var(--green)':'var(--muted)';
      const arrow=v>0?'â†‘':v<0?'â†“':'â†’';
      deltaHtml=`<span style="font-family:var(--font-mono);font-size:11px;color:${col}">${v>0?'+':''}${d} kg ${arrow}</span>`;
    }
    return `
    <div class="hist-row">
      <div style="flex:1">
        <div style="display:flex;align-items:center;gap:7px">
          <span style="font-family:var(--font-mono);font-size:11px;color:var(--muted)">${formatDate(w.date)}</span>
          ${isToday?'<span class="badge badge-green" style="font-size:9px;padding:2px 7px">OGGI</span>':''}
        </div>
        <div id="wd-${w.date}" style="display:flex;align-items:center;gap:10px;margin-top:2px">
          <span style="font-family:var(--font-brand);font-weight:900;font-size:20px;color:var(--green)">${w.weight} kg</span>
          ${deltaHtml}
        </div>
        <div id="we-row-${w.date}" style="display:none;align-items:center;gap:8px;margin-top:4px">
          <input type="number" id="we-${w.date}" value="${w.weight}" step="0.1" style="width:100px;font-family:var(--font-brand);font-weight:700;font-size:16px;text-align:center"
            onkeydown="if(event.key==='Enter')confirmWeightEdit('${w.date}');if(event.key==='Escape')cancelWeightEdit('${w.date}')">
          <span style="color:var(--muted);font-size:13px">kg</span>
          <button class="btn btn-green btn-sm" onclick="confirmWeightEdit('${w.date}')">âœ“</button>
          <button class="btn btn-ghost btn-sm" onclick="cancelWeightEdit('${w.date}')">âœ•</button>
        </div>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn btn-ghost btn-icon btn-sm" title="Modifica" onclick="startWeightEdit('${w.date}')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>
        <button class="btn btn-danger btn-icon btn-sm" title="Elimina" onclick="deleteWeight('${w.date}')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4h6v2"/></svg>
        </button>
      </div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// USER FOODS (personal database)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadUserFoods() {
  const {db, collection, getDocs, query, orderBy} = window._fb;
  const snap = await getDocs(query(collection(db,'users',uid(),'foods'), orderBy('name','asc')));
  userFoods = snap.docs.map(d=>({id:d.id,...d.data()}));
  renderFoodsList();
}

function renderFoodsList(filter='') {
  const el = document.getElementById('foods-list');
  if (!el) return;
  const fl = filter.toLowerCase();
  const items = userFoods.filter(f=>!fl||f.name.toLowerCase().includes(fl));
  if (!items.length) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ¥—</div><p>'+(filter?'Nessun risultato per "'+filter+'"':'Nessun alimento creato ancora.')+'</p></div>';
    return;
  }
  el.innerHTML = items.map(f=>`
    <div class="food-card">
      <div>
        <div class="food-name">${f.name}</div>
        ${f.notes?`<div style="font-size:12px;color:var(--muted);margin-top:2px">${f.notes}</div>`:''}
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <span class="macro-pill mp-kcal">${f.kcal} kcal</span>
        <span class="macro-pill mp-prot">P ${f.protein}g</span>
        <span class="macro-pill mp-carb">C ${f.carbs}g</span>
        <span class="macro-pill mp-fat">G ${f.fat}g</span>
        <span style="font-family:var(--font-mono);font-size:10px;color:var(--muted)">/ 100g</span>
      </div>
      <div style="display:flex;gap:6px;flex-shrink:0">
        <button class="btn btn-ghost btn-icon btn-sm" onclick="openFoodModal('${f.id}')" title="Modifica">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>
        <button class="btn btn-danger btn-icon btn-sm" onclick="deleteFood('${f.id}')" title="Elimina">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4h6v2"/></svg>
        </button>
      </div>
    </div>`
  ).join('');
}

function filterFoods() {
  renderFoodsList(document.getElementById('foods-search').value);
}

function openFoodModal(foodId=null) {
  editingFoodId = foodId;
  document.getElementById('food-modal-title').textContent = foodId ? 'Modifica Alimento' : 'Nuovo Alimento';
  if (foodId) {
    const f = userFoods.find(x=>x.id===foodId);
    if (f) {
      document.getElementById('fm-name').value = f.name;
      document.getElementById('fm-kcal').value = f.kcal;
      document.getElementById('fm-prot').value = f.protein;
      document.getElementById('fm-carb').value = f.carbs;
      document.getElementById('fm-fat').value  = f.fat;
      document.getElementById('fm-notes').value = f.notes||'';
      updateFoodModalMacros();
    }
  } else {
    ['fm-name','fm-kcal','fm-prot','fm-carb','fm-fat','fm-notes'].forEach(id=>document.getElementById(id).value='');
  }
  document.getElementById('food-modal').classList.add('open');
}

function closeFoodModal() {
  document.getElementById('food-modal').classList.remove('open');
  editingFoodId = null;
}

function updateFoodModalMacros() {
  const k=parseFloat(document.getElementById('fm-kcal').value)||0;
  const p=parseFloat(document.getElementById('fm-prot').value)||0;
  const c=parseFloat(document.getElementById('fm-carb').value)||0;
  const f=parseFloat(document.getElementById('fm-fat').value)||0;
  document.getElementById('fmp-kcal').textContent = k+' kcal';
  document.getElementById('fmp-prot').textContent = 'P '+p+'g';
  document.getElementById('fmp-carb').textContent = 'C '+c+'g';
  document.getElementById('fmp-fat').textContent  = 'G '+f+'g';
}

async function saveFoodItem() {
  const name  = document.getElementById('fm-name').value.trim();
  const kcal  = parseFloat(document.getElementById('fm-kcal').value);
  const prot  = parseFloat(document.getElementById('fm-prot').value)||0;
  const carbs = parseFloat(document.getElementById('fm-carb').value)||0;
  const fat   = parseFloat(document.getElementById('fm-fat').value)||0;
  const notes = document.getElementById('fm-notes').value.trim();
  if (!name||!kcal) { toast('Nome e kcal sono obbligatori!','var(--danger)'); return; }
  const {db, doc, setDoc, addDoc, collection, updateDoc} = window._fb;
  const data = { name, kcal, protein:prot, carbs, fat, notes, updatedAt:Date.now() };
  if (editingFoodId) {
    await updateDoc(doc(db,'users',uid(),'foods',editingFoodId), data);
    toast('Alimento aggiornato!');
  } else {
    data.createdAt = Date.now();
    await addDoc(collection(db,'users',uid(),'foods'), data);
    toast('Alimento salvato!');
  }
  closeFoodModal();
  await loadUserFoods();
}

async function deleteFood(foodId) {
  if (!confirm('Eliminare questo alimento?')) return;
  const {db, doc, deleteDoc} = window._fb;
  await deleteDoc(doc(db,'users',uid(),'foods',foodId));
  toast('Alimento eliminato','var(--danger)');
  await loadUserFoods();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DIARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setDiaryToday() {
  currentDiaryDate = todayStr();
  document.getElementById('diary-date').value = currentDiaryDate;
  loadDiary();
}

async function loadDiary() {
  currentDiaryDate = document.getElementById('diary-date').value || todayStr();
  const {db, doc, getDoc} = window._fb;
  const snap = await getDoc(doc(db,'users',uid(),'diary',currentDiaryDate));
  diaryEntries = snap.exists() ? (snap.data().entries||[]) : [];
  renderDiary();
  if (currentDiaryDate === todayStr()) updateHomeDiarySummary();
}

async function saveDiary() {
  const {db, doc, setDoc} = window._fb;
  await setDoc(doc(db,'users',uid(),'diary',currentDiaryDate), {
    entries: diaryEntries, date: currentDiaryDate, updatedAt: Date.now()
  });
}

function searchDiaryFood() {
  const q = document.getElementById('diary-food-search').value.toLowerCase().trim();
  const ac = document.getElementById('diary-ac');
  if (!q) { ac.classList.remove('open'); selectedDiaryFood=null; return; }
  // Search personal foods first, then INRAN
  const personalHits = userFoods.filter(f=>f.name.toLowerCase().includes(q)).map(f=>({...f,source:'personal'}));
  const inranHits = INRAN.filter(f=>f.n.toLowerCase().includes(q)&&!personalHits.find(p=>p.name===f.n)).map(f=>({name:f.n,kcal:f.kcal,protein:f.p,carbs:f.c,fat:f.f,source:'inran',cat:f.cat}));
  const all = [...personalHits, ...inranHits].slice(0,12);
  if (!all.length) { ac.classList.remove('open'); return; }
  ac.innerHTML = all.map((f,i)=>`
    <div class="ac-item" onclick="selectDiaryFood(${i})">
      <div>
        <span style="font-size:13px;font-weight:600">${f.name}</span>
        ${f.source==='personal'?'<span class="badge badge-green" style="font-size:9px;margin-left:6px">mio</span>':''}
        ${f.cat?`<span style="font-size:10px;color:var(--muted);margin-left:4px">[${f.cat}]</span>`:''}
      </div>
      <span style="font-family:var(--font-mono);font-size:10px;color:var(--muted)">${f.kcal} kcal/100g</span>
    </div>`).join('');
  ac._data = all;
  ac.classList.add('open');
}

function selectDiaryFood(idx) {
  const ac = document.getElementById('diary-ac');
  selectedDiaryFood = ac._data[idx];
  document.getElementById('diary-food-search').value = selectedDiaryFood.name;
  ac.classList.remove('open');
}

async function addToDiary() {
  if (!selectedDiaryFood) { toast('Seleziona un alimento!','var(--danger)'); return; }
  const grams = parseFloat(document.getElementById('diary-grams').value)||100;
  const f = grams/100;
  diaryEntries.push({
    id: Date.now(),
    name: selectedDiaryFood.name,
    grams,
    kcal:  Math.round(selectedDiaryFood.kcal  * f),
    protein: parseFloat((selectedDiaryFood.protein * f).toFixed(1)),
    carbs: parseFloat((selectedDiaryFood.carbs   * f).toFixed(1)),
    fat:   parseFloat((selectedDiaryFood.fat     * f).toFixed(1))
  });
  await saveDiary();
  document.getElementById('diary-food-search').value='';
  document.getElementById('diary-grams').value='100';
  selectedDiaryFood=null;
  renderDiary();
  if (currentDiaryDate===todayStr()) updateHomeDiarySummary();
  toast('Aggiunto al diario!');
}

async function removeDiaryEntry(id) {
  diaryEntries = diaryEntries.filter(e=>e.id!==id);
  await saveDiary();
  renderDiary();
  if (currentDiaryDate===todayStr()) updateHomeDiarySummary();
}

function diaryTotals() {
  return diaryEntries.reduce((t,e)=>({
    kcal:  t.kcal  + e.kcal,
    protein: t.protein + e.protein,
    carbs: t.carbs + e.carbs,
    fat:   t.fat   + e.fat
  }), {kcal:0,protein:0,carbs:0,fat:0});
}

function renderDiary() {
  const totals = diaryTotals();
  document.getElementById('d-kcal').textContent = totals.kcal;
  document.getElementById('d-prot').textContent = totals.protein.toFixed(1)+'g';
  document.getElementById('d-carb').textContent = totals.carbs.toFixed(1)+'g';
  document.getElementById('d-fat').textContent  = totals.fat.toFixed(1)+'g';
  const el = document.getElementById('diary-entries');
  if (!diaryEntries.length) {
    el.innerHTML='<div class="empty"><div class="empty-icon">ğŸ½ï¸</div><p>Nessun alimento nel diario di questa giornata.</p></div>';
    return;
  }
  el.innerHTML = diaryEntries.map(e=>`
    <div class="diary-entry">
      <div style="flex:1">
        <div class="food-name">${e.name}</div>
        <div style="font-size:12px;color:var(--muted);margin-top:2px">${e.grams}g</div>
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <span class="macro-pill mp-kcal">${e.kcal} kcal</span>
        <span class="macro-pill mp-prot">P ${e.protein}g</span>
        <span class="macro-pill mp-carb">C ${e.carbs}g</span>
        <span class="macro-pill mp-fat">G ${e.fat}g</span>
      </div>
      <button class="btn btn-danger btn-icon btn-sm" onclick="removeDiaryEntry(${e.id})">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M9 6V4h6v2"/></svg>
      </button>
    </div>`).join('');
}

async function updateHomeDiarySummary() {
  // Load today's diary for home summary
  const {db, doc, getDoc} = window._fb;
  const snap = await getDoc(doc(db,'users',uid(),'diary',todayStr()));
  const entries = snap.exists() ? (snap.data().entries||[]) : [];
  const t = entries.reduce((a,e)=>({kcal:a.kcal+e.kcal,protein:a.protein+e.protein,carbs:a.carbs+e.carbs,fat:a.fat+e.fat}),{kcal:0,protein:0,carbs:0,fat:0});
  const el = document.getElementById('home-macro-summary');
  if (el) el.innerHTML = `
    <div class="macro-box"><div class="mval" style="color:var(--green)">${t.kcal}</div><div class="mlbl">KCAL</div></div>
    <div class="macro-box"><div class="mval" style="color:var(--orange)">${t.protein.toFixed(1)}g</div><div class="mlbl">PROTEINE</div></div>
    <div class="macro-box"><div class="mval" style="color:#3b82f6">${t.carbs.toFixed(1)}g</div><div class="mlbl">CARBOIDRATI</div></div>
    <div class="macro-box"><div class="mval" style="color:#ca8a04">${t.fat.toFixed(1)}g</div><div class="mlbl">GRASSI</div></div>`;
  const te = document.getElementById('home-today-entries');
  if (te) te.textContent = entries.length ? entries.slice(0,3).map(e=>e.name).join(', ') + (entries.length>3?` +${entries.length-3} altri`:'') : 'Nessun alimento registrato oggi.';
}

// close autocomplete on outside click
document.addEventListener('click', e=>{
  const ac = document.getElementById('diary-ac');
  if(ac&&!ac.contains(e.target)&&e.target.id!=='diary-food-search') ac.classList.remove('open');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadGoal() {
  const {db, doc, getDoc} = window._fb;
  const snap = await getDoc(doc(db,'users',uid(),'goals','main'));
  goalData = snap.exists() ? snap.data() : null;
  if (goalData) {
    document.getElementById('goal-start').value = goalData.startWeight||'';
    document.getElementById('goal-target').value = goalData.targetWeight||'';
    document.getElementById('goal-note').value = goalData.note||'';
  }
  renderGoalProgress();
}

async function saveGoal() {
  const start  = parseFloat(document.getElementById('goal-start').value);
  const target = parseFloat(document.getElementById('goal-target').value);
  const note   = document.getElementById('goal-note').value;
  if (!start||!target) { toast('Inserisci peso di partenza e obiettivo!','var(--danger)'); return; }
  const {db, doc, setDoc} = window._fb;
  await setDoc(doc(db,'users',uid(),'goals','main'), {startWeight:start,targetWeight:target,note,updatedAt:Date.now()});
  goalData = {startWeight:start,targetWeight:target,note};
  toast('Obiettivo salvato!');
  renderGoalProgress();
}

function renderGoalProgress() {
  const el = document.getElementById('goal-progress-card');
  if (!el) return;
  if (!goalData) { el.innerHTML='<div class="card"><div class="empty"><div class="empty-icon">ğŸ¯</div><p>Imposta il tuo obiettivo per vedere i progressi.</p></div></div>'; return; }
  const current = weightData.length ? [...weightData].sort((a,b)=>b.date.localeCompare(a.date))[0].weight : null;
  const {startWeight:start, targetWeight:target, note} = goalData;
  let pct=0,statusText='',statusColor='var(--green)';
  if (current&&start!==target) {
    const totalChange = target-start;
    const currChange  = current-start;
    pct = Math.min(100,Math.max(0,(currChange/totalChange)*100));
    const diff = (current-target).toFixed(1);
    const dv = parseFloat(diff);
    if (Math.abs(dv)<0.3) { statusText='ğŸ¯ Obiettivo raggiunto!'; statusColor='var(--green)'; }
    else if (dv<0) { statusText=`Ancora ${Math.abs(dv)} kg da perdere`; statusColor='var(--orange)'; }
    else { statusText=`+${dv} kg sopra l'obiettivo`; statusColor='var(--danger)'; }
  }
  el.innerHTML = `
    <div class="card">
      <h3 style="margin-bottom:16px">ğŸ“Š I tuoi progressi</h3>
      <div class="grid-3" style="margin-bottom:18px">
        <div class="stat-chip"><div class="val" style="color:var(--muted)">${start} kg</div><div class="lbl">PARTENZA</div></div>
        <div class="stat-chip"><div class="val" style="color:var(--green)">${current?current.toFixed(1)+' kg':'â€”'}</div><div class="lbl">ATTUALE</div></div>
        <div class="stat-chip"><div class="val" style="color:var(--orange)">${target} kg</div><div class="lbl">OBIETTIVO</div></div>
      </div>
      ${current?`
        <div style="display:flex;justify-content:space-between;margin-bottom:6px;font-size:13px">
          <span style="color:${statusColor};font-weight:700">${statusText}</span>
          <span style="font-family:var(--font-mono);font-size:13px;color:var(--green);font-weight:600">${pct.toFixed(0)}%</span>
        </div>
        <div class="progress-track">
          <div class="progress-fill" style="width:${pct}%;background:var(--green)"></div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:6px;font-family:var(--font-mono);font-size:10px;color:var(--muted)">
          <span>${start} kg</span><span>${target} kg</span>
        </div>
      `:'<p style="color:var(--muted);font-size:13px">Inserisci il peso per vedere i progressi.</p>'}
      ${note?`<div style="margin-top:16px;padding:12px;background:var(--cream);border-radius:10px;font-size:13px;color:var(--text2)">${note}</div>`:''}
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BMI CALC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcBMI() {
  const w = parseFloat(document.getElementById('bmi-weight').value);
  const h = parseFloat(document.getElementById('bmi-height').value)/100;
  const el = document.getElementById('bmi-result');
  if (!w||!h||h<0.5) { el.textContent=''; return; }
  const bmi = (w/(h*h)).toFixed(1);
  let cat='',col='var(--green)';
  if(bmi<18.5){cat='Sottopeso';col='#3b82f6';}
  else if(bmi<25){cat='Normopeso';col='var(--green)';}
  else if(bmi<30){cat='Sovrappeso';col='var(--orange)';}
  else{cat='ObesitÃ ';col='var(--danger)';}
  el.innerHTML=`<span style="color:${col}">${bmi}</span><span style="font-size:12px;font-weight:400;color:${col};margin-left:6px">${cat}</span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAdminUsers() {
  const {db, collection, getDocs, query, orderBy} = window._fb;
  const snap = await getDocs(query(collection(db,'users'), orderBy('createdAt','asc')));
  const users = snap.docs.map(d=>({uid:d.id,...d.data()}));
  document.getElementById('admin-user-count').textContent = users.length + ' utenti registrati';

  // For each user, get last weight
  const rows = await Promise.all(users.map(async u => {
    const ws = await getDocs(query(collection(db,'users',u.uid,'weights'), orderBy('date','desc'), window._fb.limit(1)));
    const lastW = ws.empty ? null : ws.docs[0].data().weight;
    return {...u, lastWeight: lastW};
  }));

  const tbody = document.getElementById('admin-tbody');
  tbody.innerHTML = rows.map(u=>`
    <tr onclick="viewUserDetail('${u.uid}','${u.name||u.email}')">
      <td><strong>${u.name||'â€”'}</strong></td>
      <td style="font-family:var(--font-mono);font-size:12px">${u.email}</td>
      <td>${u.role==='admin'?'<span class="badge badge-admin">Admin</span>':'<span class="badge badge-green">Utente</span>'}</td>
      <td style="font-family:var(--font-mono);font-size:11px;color:var(--muted)">${u.createdAt?new Date(u.createdAt).toLocaleDateString('it-IT'):'â€”'}</td>
      <td>${u.lastWeight?`<strong style="color:var(--green)">${u.lastWeight} kg</strong>`:'<span style="color:var(--muted)">â€”</span>'}</td>
      <td><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();viewUserDetail('${u.uid}','${u.name||u.email}')">Visualizza â†’</button></td>
    </tr>`).join('');
}

let adminChartInst = null;
async function viewUserDetail(targetUid, name) {
  document.getElementById('admin-user-list').style.display = 'none';
  document.getElementById('admin-user-detail').style.display = 'block';
  document.getElementById('admin-detail-name').textContent = name;

  const {db, collection, query, orderBy, getDocs} = window._fb;
  const snap = await getDocs(query(collection(db,'users',targetUid,'weights'), orderBy('date','asc')));
  const data = snap.docs.map(d=>d.data());

  // Stats
  if (data.length) {
    const s = [...data].sort((a,b)=>b.date.localeCompare(a.date));
    document.getElementById('adm-last').textContent = s[0].weight+' kg';
    const weekAgo=new Date();weekAgo.setDate(weekAgo.getDate()-7);
    const wk=data.filter(w=>new Date(w.date+'T00:00:00')>=weekAgo);
    document.getElementById('adm-weekly').textContent = wk.length?(wk.reduce((a,b)=>a+b.weight,0)/wk.length).toFixed(1)+' kg':'â€”';
    const mo=todayStr().slice(0,7);
    const mm=data.filter(w=>w.date.startsWith(mo));
    document.getElementById('adm-monthly').textContent = mm.length?(mm.reduce((a,b)=>a+b.weight,0)/mm.length).toFixed(1)+' kg':'â€”';
  }

  // Chart
  if (adminChartInst) adminChartInst.destroy();
  const ctx = document.getElementById('admin-chart').getContext('2d');
  adminChartInst = new Chart(ctx, {
    type:'line',
    data:{labels:data.map(w=>new Date(w.date+'T00:00:00').toLocaleDateString('it-IT',{day:'2-digit',month:'short'})),
      datasets:[{label:'Peso',data:data.map(w=>w.weight),borderColor:'#e07020',backgroundColor:'rgba(224,112,32,0.08)',
        fill:true,tension:0.4,pointBackgroundColor:'#e07020',pointRadius:4}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
      scales:{x:{grid:{color:'rgba(0,0,0,0.05)'},ticks:{color:'#9a8f85',font:{size:10}}},
              y:{grid:{color:'rgba(0,0,0,0.05)'},ticks:{color:'#9a8f85',font:{size:10},callback:v=>v+' kg'}}}}
  });

  // Weight list
  const wl = document.getElementById('admin-weight-list');
  const sorted = [...data].sort((a,b)=>b.date.localeCompare(a.date));
  wl.innerHTML = sorted.map(w=>`
    <div class="hist-row">
      <span style="font-family:var(--font-mono);font-size:11px;color:var(--muted);flex:1">${formatDate(w.date)}</span>
      <span style="font-family:var(--font-brand);font-weight:800;font-size:17px;color:var(--orange)">${w.weight} kg</span>
    </div>`).join('');
}

function closeUserDetail() {
  document.getElementById('admin-user-list').style.display='block';
  document.getElementById('admin-user-detail').style.display='none';
}
</script>
</body>
</html>
